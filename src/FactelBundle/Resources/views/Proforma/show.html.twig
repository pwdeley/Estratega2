{% extends "FactelBundle::Layout.html.twig" %}
{% block panel_title %}

    <i class="fa fa-bar-chart-o fa-fw"></i>Proforma <strong>Nro: {{entity.numero}}</strong>
    <div class="pull-right">
        <div class="btn-group">
            <button class="btn btn-info btn-xs dropdown-toggle"
                    type="button" data-toggle="dropdown">
                <i class="fa fa-list"></i>
                Acciones <span class="caret"></span>
            </button>
            <ul class="dropdown-menu dropdown-menu-right" role="menu">
                <li><a href="{{ path('proforma_new') }}"><i class="fa fa-plus-circle"></i> Nueva</a></li>
                    {% if entity.estado == 'CREADA' %}
                    <li><a href="{{ path('proforma_edit',{ 'id': entity.id }) }}"><i class="fa fa-pencil-square-o"></i> Editar</a></li>
                    {% endif %}
                <li><a href="{{ path('proforma') }}"><i class="fa fa-list"></i> Proformas</a></li>
                <li class="divider"></li>
                    {% if entity.estado != 'ANULADA' and  entity.estado != 'MIGRADA'%}
                    <li><a href="{{ path('proforma_enviar',{ 'id': entity.id }) }}"><i class="fa fa-paper-plane"></i> Enviar Proforma</a></li>
                    <li><a href="{{ path('proforma_migrar',{ 'id': entity.id }) }}"><i class="fa fa-paper-plane"></i> Migrar a Factura</a></li>

                {% endif %}
                {% if entity.estado == 'ENVIADA' or entity.estado == 'MIGRADA' or entity.estado == 'ERROR EMAIL'%}        
                    <li><a href="{{ path('proforma_descargar',{ 'id': entity.id , 'type': "pdf"}) }}"><i class="fa fa-file-pdf-o"></i> Descargar PDF</a></li>
                    {% endif %}
                    {% if entity.estado != 'ANULADA' and entity.estado != 'MIGRADA' %}
                    <li><a href="{{ path('proforma_anular',{ 'id': entity.id }) }}"><i class="fa fa-times-circle"></i> Anular Proforma</a></li>
                    {% endif %}
                    {% if entity.estado != 'MIGRADA' %}
                    <li class="divider"></li>
                    <li><a href="{{ path('proforma_eliminar',{ 'id': entity.id }) }}"><i class="glyphicon glyphicon-trash"></i> Eliminar Proforma</a></li>  
                    {% endif %}
            </ul>
        </div>

    </div>
{% endblock %}
{% block content %}
    <div class="container-fluid factura">
        {% for flashMessage in app.session.flashbag.get('notice') %}
            <div class="col-sm-12 alert alert-danger alert-dismissable">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <h4><strong>Ha ocurrido un error!</strong></h4>
                <p>{{ flashMessage }}</p>
            </div>
        {% endfor %}
        {% for flashMessage in app.session.flashbag.get('confirm') %}
            <div class="col-sm-12 alert alert-success alert-dismissable">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <p>{{ flashMessage }}</p>
            </div>
        {% endfor %}
        <div class="modal fade" id="send-email" tabindex="-1" role="dialog" 
             aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <!-- Modal Header -->
                    <div class="modal-header">
                        <button type="button" class="close" 
                                data-dismiss="modal">
                            <span aria-hidden="true">&times;</span>
                            <span class="sr-only">Close</span>
                        </button>
                        <h4 class="modal-title" id="myModalLabel">
                            Enviar Email
                        </h4>
                    </div>
                    <div class="modal-body">
                        <div class="col-sm-12 alert alert-info">
                            <p>Ingrese el email al cual desea enviar el documento. Para mas de un email separarlo por coma (,) ejemplo: email1@gmail.com,email2@gmail.com</p>
                        </div>
                        <form role="form" method="POST" action="{{ path('factura_enviar_email',{ 'id': entity.id }) }}" id="formEmail">
                            <div class="form-group">
                                <label for="Email">Email</label>
                                <input type="text" class="form-control"
                                       name="email" id="email" placeholder="Email separados por coma"/>
                            </div>
                            <button id="send" type="submit" class="btn btn-default">Enviar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% if entity.mensajes | length >0  and entity.estado != "AUTORIZADO" %}
            <div class="col-sm-12 alert alert-danger alert-dismissable">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <h5><strong>Errores ocurrido durante el envio del email!</strong></h5>
                {% for item in entity.mensajes %}
                    <p>{{item.mensaje}}</p>
                    <p>{{item.informacionAdicional}}</p>
                {% endfor %}
            </div>
        {% endif %}
        <fieldset class="border col-sm-12">
            <legend class="border">Emisor</legend>
            <div class="control-group" id="emisor">
                <div class="col-sm-12"><p class="text-center"><strong>Ruc:</strong> {{entity.emisor.ruc}}</p></div>
                <div class="col-sm-12 col-md-6"><strong>Raz&oacute;n Social:</strong> {{entity.emisor.razonSocial}}</div>
                <div class="col-sm-12 col-md-6"><strong>Nombre Comercial:</strong> {%if entity.establecimiento.nombreComercial%}{{entity.establecimiento.nombreComercial}}{%else%}{{entity.emisor.nombreComercial}}{%endif%}</div>
                <div class="col-sm-12 col-md-6"><strong>Contribuyente Especial:</strong> {{entity.emisor.contribuyenteEspecial}}</div>
                <div class="col-sm-12 col-md-6"><strong>Obligado Contabilidad:</strong> {{entity.emisor.obligadoContabilidad}}</div>
                <div class="col-sm-12 col-md-6"><strong>Direcci&oacute;n Matriz:</strong> {{entity.emisor.direccionMatriz}}</div>
                <div class="col-sm-12 col-md-6"><strong>Direcci&oacute;n Establecimiento:</strong> {{entity.establecimiento.direccion}}</div>
            </div>
        </fieldset>

        <fieldset class="border  col-sm-12 ">
            <legend class="border">Proforma</legend>
            <div class="control-group" id="comprobante">
                <div class="col-sm-12 col-md-6"><strong>Estado: </strong><strong><span class="{%if entity.estado == 'CREADA'%}creada{%elseif entity.estado == 'ENVIADA' or entity.estado == 'MIGRADA'%}autorizada{%else%} error {%endif%}">{{entity.estado}}</span></strong></div>
                <div class="col-sm-12 col-md-6"><strong>Fecha Emisi&oacute;n:</strong>{{entity.fechaEmision |date('d/m/Y')}}</div>
            </div>
        </fieldset>

        <fieldset class="border col-sm-12">

            <legend class="border">Cliente</legend>

            <div class="form-group">
                <input type="text" id="id" class="form-control hidden" name="id">
                <div class="col-md-6">
                    <strong>Nombre: </strong>{{entity.cliente.nombre}}
                </div>
                <div class="col-md-6">
                    <strong>Celular: </strong>{{entity.cliente.celular}}
                </div>
                <div class="col-md-6">
                    <strong>Email: </strong>{{entity.cliente.correoElectronico}}
                </div>
                <div class="col-md-6">
                    <strong>Identificaci&oacute;n: </strong>{{entity.cliente.identificacion}}
                </div>
                <div class="col-md-6">
                    <strong>Direcci&oacute;n: </strong>{{entity.cliente.direccion}}
                </div>
            </div>
        </fieldset>
        <legend class="border">Productos</legend>
        <div class="dataTable_wrapper table-responsive col-lg-12">  
            <table class="table table-striped table-bordered table-hover" id="productos">
                <thead>
                <thead>
                    <tr>
                        <th >Cantidad</th>
                        <th>C&oacute;digo</th>
                        <th>Descripci&oacute;n</th>
                        <th>Precio</th>
                        <th>Descuento</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in entity.proformasHasProducto%}
                        <tr>
                            <td>{{item.cantidad}}</td>
                            <td>{{item.codigoProducto}}</td>
                            <td>{{item.nombre}}</td>
                            <td>{{item.precioUnitario}}</td>
                            <td>{{item.descuento}}</td>
                            <td>{{item.valorTotal}}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>

    <div class="col-xs-12 col-sm-12 col-md-4 col-md-offset-8">

        <div class="col-xs-10 col-sm-8 text-right">SubTotal Sin Impuesto</div> 
        <div class="col-xs-2 col-sm-4">
            <p class="text-left" >{{entity.totalSinImpuestos}}</p>
        </div>
        <div class="col-xs-10 col-sm-8 text-right">Sub Total 12%</div>
        <div class="col-xs-2 col-sm-4">
            <p class="text-left">{{entity.subtotal12}}</p>
        </div>
        <div class="col-xs-10 col-sm-8 text-right">Descuento</div>
        <div class="col-xs-2 col-sm-4">
            <p class="text-left">{{entity.totalDescuento}}</p>
        </div>

        <div class="col-xs-10 col-sm-8 text-right">IVA 12%</div>
        <div class="col-xs-2 col-sm-4">
            <p class="text-left">{{entity.iva12}}</p>
        </div>
        <div class="col-xs-10 col-sm-8 text-right">VALOR TOTAL</div>
        <div class="col-xs-2 col-sm-4">
            <p class="text-left" id="valorTotal">{{entity.valorTotal}}</p>
        </div>
    </div>
{% endblock %}
{% block javascript %}
    <script>
        $('#send').click(function () {
            $('#send-email').modal('toggle');
        });
    </script>
{% endblock %}